#include <stdint.h>
#include "proc.h"
#include "uart.h"
#include "sdr.h"
#include "../include/config.h"

#define REGD(a)		(*(volatile uint32_t *)(a))


void udelay(uint32_t us)
{
	us *= 60;
	while (us--)
	{
		REGD(0x08100828);
	}
}

#if defined CONFIG_ACCIO_P1_LITE
int lite_ddr_start(void)
{
	REGD(0x0810000C) = 0x0110;
	REGD(0x0800100C) = 0xff;
	REGD(0x08001010) = 0x210020;
	REGD(0x08001020) = 0x1d0021;
	REGD(0x08001030) = 0x7d0020;
	REGD(0x08001040) = 0x1d0021;
	REGD(0x08001050) = 0x7d0020;
	REGD(0x08001054) = 0x111122;
	REGD(0x08100828) = 0x0a000000;
	REGD(0x08000008) = 0x00000003;
	REGD(0x0800000c) = 0x753877ff;
	REGD(0x08000010) = 0x753877fe;
	REGD(0x08000008) = 0x00000041;
	REGD(0x08000008) = 0x00000049;
	REGD(0x08000008) = 0x10000049;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x08000008) = 0x20000049;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x08000018) = 0x00000031;
	REGD(0x08000008) = 0x30000049;
	REGD(0x50000000) = 0x0;
	REGD(0x08000018) = 0x00020020;
	REGD(0x08000008) = 0x30000049;
	REGD(0x50000000) = 0x0;
	REGD(0x08000008) = 0x20000049;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x08000024) = 0x1f200001;
	REGD(0x08000008) = 0x00000099;
	REGD(0x08000020) = 0x3c3c3c3c;
	REGD(0x08000008) = 0x0000009d;

	return 0;
}
#endif

#if defined CONFIG_ACCIO_P1_SK01
int sk01_ddr_start(void)
{
	//max speed
	REGD(0x810000C) = 0x0110;
		
	//Set expio
	REGD(0x800100C) = 0xff;
	REGD(0x8001010) = 0x1d0020;
	REGD(0x8001020) = 0x1d0021;
	REGD(0x8001030) = 0x1d0021;
	REGD(0x8001040) = 0x1d0021;
	REGD(0x8001050) = 0x7d0020;
	REGD(0x8001054) = 0x111122;
	
	
	//set drive strength, LVCMOS,S1 of MDDR to 16mA
	REGD(0x08100828) = 0x0a000000;
	
	//Sdram command, reset & enable
	REGD(0x08000008) = 0x00000003;
	
	//ADS board have 2x32 MB DDR
	//Sdrm config, row=13, col=9,BL=8 32bit, 1 clk precharge delay
	//32 kHz clock is used for refresh
	//refresh rate = 7.81us
	REGD(0x0800000c) = 0x793877ff;
	REGD(0x08000010) = 0x793877ff;
		
	//SDRAM delay Tap control
	//SDRAMC enable
	REGD(0x08000008) = 0x00000041;
	
	//SDRAM delay Tap control
	//SDRAMC Startup
	REGD(0x08000008) = 0x00000049;
	REGD(0x08000008) = 0x10000049;
	
	//Write to CS0
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	
	//Write to CS1
	REGD(0x90000000) = 0x0;
	REGD(0x90000000) = 0x0;
		
	//Auto refresh command
	REGD(0x08000008) = 0x20000049;
	
	//Write to CS0
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	
	//Write to CS1
	REGD(0x90000000) = 0x0;
	REGD(0x90000000) = 0x0;
	REGD(0x90000000) = 0x0;
	REGD(0x90000000) = 0x0;
	REGD(0x90000000) = 0x0;
	REGD(0x90000000) = 0x0;
	REGD(0x90000000) = 0x0;
	REGD(0x90000000) = 0x0;
	
	//SDRAMC Mode register
	REGD(0x08000018) = 0x00000031;	
	//Set Mode register command
	REGD(0x08000008) = 0x30000049;
	
	REGD(0x50000000) = 0x0;
	REGD(0x90000000) = 0x0;
	
	//SDRAMC Mode register
	REGD(0x08000018) = 0x00020000;	
	//Set Mode register command
	REGD(0x08000008) = 0x30000049;
	
	
	REGD(0x50000000) = 0x0;
	REGD(0x90000000) = 0x0;
	
	//Auto refresh command
	REGD(0x08000008) = 0x20000049;
	
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x90000000) = 0x0;
	REGD(0x90000000) = 0x0;
	
	//SDRAMC tunning config
	REGD(0x08000024) = 0x1f200001;
	
	//Normal Read/Write
	//DDR=1, CLKSEL=1, 
	REGD(0x08000008) = 0x00000099;
	
	//SDRAMC delay tunning Data
	REGD(0x08000020) = 0x3c3c3c3c;
	
	//normal r/w, ddr, internal tuning clk, powerup, low power mode, enable
	//REGD(0x08000008) = 0x0000009d;
	//32 kHz clock is used for refresh
	REGD(0x08000008) = 0x000000dd;
			
	return 0;
}
#endif

#if defined CONFIG_ACCIO_P1 || defined CONFIG_ADS
int sdramc_start (void)
{
#if defined CONFIG_ACCIO_P1_SK01
	sk01_ddr_start();
#elif defined CONFIG_ACCIO_P1_LITE
	lite_ddr_start();
#else
	sdr_cfg_t cfg;

	/* enable lvcmos */
	REGD(0x08100828) = 0x02000000;

	if (sdr_init (SDR_REG_BASE) < 0)
	{
		puts ("sdramc initialisation failed\n");
		return -1;
	}

	sdr_enable (SDR_REG_BASE);	  // clk running, cke low for 200us
	udelay (200);
	sdr_power_up (SDR_REG_BASE);	// clk running, cke high for 200us
	udelay (200);

	// configure cs0
	cfg.cs = 0;
	cfg.dsz = 1;	// 1=32-bit, 0=16-bit
	cfg.row = 13;
	cfg.col = 9;
	cfg.bl = 8;
	cfg.cas = 3;

	if (sdr_start (SDR_REG_BASE, &cfg) < 0)
	{
		puts ("sdramc csd0 start up failed\n");
		return -1;
	}
#ifdef CONFIG_ADS
	// configure cs1
	cfg.cs = 1;
	if (sdr_start (SDR_REG_BASE, &cfg) < 0)
	{
		puts ("sdramc csd1 start up failed\n");
		return -1;
	}
#endif
	return 0;
#endif
}
#endif

#if CONFIG_ACCIO_P0
int sdramc_sdr_init(void)
{
	REGD(0x08100828) = 0x02000000;
	REGD(0x08000008) = 0x00000003;
	REGD(0x0800000c) = 0x793867ff;
	REGD(0x08000010) = 0x793867fe;
	REGD(0x08000008) = 0x00000141;
	REGD(0x08000008) = 0x00000149;
	REGD(0x08000008) = 0x10000149;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x08000008) = 0x20000149;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x08000018) = 0x00000030;
	REGD(0x08000008) = 0x30000149;
	REGD(0x50000000) = 0x0;
	REGD(0x08000018) = 0x00020000;
	REGD(0x08000008) = 0x30000149;
	REGD(0x50000000) = 0x0;
	REGD(0x08000008) = 0x20000149;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x08000008) = 0x00000149;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x08000008) = 0x00000159;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x08000008) = 0x60000159;
	REGD(0x50000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000000) = 0x0;
	REGD(0x08000008) = 0x00000159;

	return 0;
}
#endif

#if defined CONFIG_CM5208 || defined CONFIG_A2818T || defined CONFIG_WE8623_P0
int sdramc_ddr_init(void)
{
	REGD(0x810000C) = 0x0110;
	REGD(0x800100C) = 0xff;
	REGD(0x8001010) = 0x1d0020;
	REGD(0x8001020) = 0x1d0021;
	REGD(0x8001030) = 0x1d0021;
	REGD(0x8001040) = 0x1d0021;
	REGD(0x8001050) = 0x7d0020;
	REGD(0x8001054) = 0x111122;
	REGD(0x08100828) = 0x0a000000;
	REGD(0x08000008) = 0x00000003;
	REGD(0x0800000c) = 0x793877ff;
	REGD(0x08000010) = 0x793877fe;
	REGD(0x08000008) = 0x00000041;
	REGD(0x08000008) = 0x00000049;
	REGD(0x08000008) = 0x10000049;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	REGD(0x08000008) = 0x20000049;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	REGD(0x08000018) = 0x00000031;
	REGD(0x08000008) = 0x30000049;
	REGD(0x50000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	REGD(0x08000018) = 0x00020000;
	REGD(0x08000008) = 0x30000049;
	REGD(0x50000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	REGD(0x08000008) = 0x20000049;
	REGD(0x50000000) = 0x0;
	REGD(0x50000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	//REGD(0x90000000) = 0x0;
	REGD(0x08000024) = 0x1f200001;
	REGD(0x08000008) = 0x00000099;
	REGD(0x08000020) = 0x3c3c3c3c;
	REGD(0x08000008) = 0x0000009d;

	return 0;
}
#endif

#ifdef CONFIG_ADS
int expio_init (void)
{
	REGD(0x810000C) = 0x110;
	REGD(0x800100C) = 0xff;
	REGD(0x8001010) = 0x1d0020;
	REGD(0x8001020) = 0x1d0021;
	REGD(0x8001030) = 0x1d0021;
	REGD(0x8001040) = 0x1d0021;
	REGD(0x8001050) = 0x7d0020;
	REGD(0x8001054) = 0x111122;
	return 0;
}
#endif

void brd_init(void)
{
#if 0
	/* disable TVOUT */
	REGD(0x08009008) = 0x3;
	REGD(0x08009008) = 0x5;
	REGD(0x0800A008) = 0x5;
#endif

	uart_init();
//	puts("\nMagus NAND FLASH loader\n");
	
	/* max speed */
	REGD(0x810000C) = 0x110;
#if 0
	/* expansion IO for ethernet */
	REGD(0x800100C) = 0xff;
	REGD(0x8001010) = 0x1d0020;
	REGD(0x8001020) = 0x1d0021;
	REGD(0x8001030) = 0x1d0021;
	REGD(0x8001040) = 0x1d0021;
	REGD(0x8001050) = 0x7d0020;
	REGD(0x8001054) = 0x111122;
#endif
#if defined CONFIG_CM5208 || defined CONFIG_A2818T
	sdramc_ddr_init();
#elif defined CONFIG_ACCIO_P1
	sdramc_start();
	/* USB charge 500mA. PD5 */
	REGD(0x0810f318) |= 0x20;
	REGD(0x0810f320) |= 0x20;
	REGD(0x0810f33c) |= 0x20;
	/* TV-IN power up. PF12 */
	REGD(0x0810f518) |= 0x1000;
	REGD(0x0810f520) |= 0x1000;
	REGD(0x0810f53c) |= 0x1000;
#elif defined  CONFIG_ACCIO_P1_SK01
	//added by pfeisu at 2008-12-03, in order to make PD19 and PD24 stable
	REGD(0x0810f31c) &= ~(1<<19);
	REGD(0x0810f41c) &= ~(1<<24);
	//added end
#elif defined CONFIG_ACCIO_P0
	sdramc_sdr_init();
#elif defined CONFIG_WE8623_P0
	sdramc_ddr_init();
	/* USB charge 500mA. PD5 */
	REGD(0x0810f318) |= 0x20;
	REGD(0x0810f320) |= 0x20;
	REGD(0x0810f33c) |= 0x20;
	/* TV-IN power up. PF12 */
	REGD(0x0810f518) |= 0x1000;
	REGD(0x0810f520) |= 0x1000;
	REGD(0x0810f53c) |= 0x1000;
#endif
#ifdef CONFIG_ADS
	expio_init();
#endif
}

void prism_cfg(void)
{
	REGD(0x0800B00C) = 0x00000001;
	REGD(0x0800B400) = 0x44440002;
	REGD(0x0800B404) = 0x00003201;
	REGD(0x0800B410) = 0x00000080;
	REGD(0x0800B414) = 0x00000080;
	REGD(0x0800B418) = 0x00000010;
	REGD(0x0800B41C) = 0x0;
	REGD(0x0800B420) = 0x00000FFF;
	REGD(0x0800B424) = 0x00000FFF;
	REGD(0x0800B428) = 0x000001FF;
	REGD(0x0800B42C) = 0x0;
	REGD(0x0800B480) = 0x44440002;
	REGD(0x0800B484) = 0x00003210;
	REGD(0x0800B490) = 0x0000001C;
	REGD(0x0800B494) = 0x00000004;
	REGD(0x0800B498) = 0x00000080;
	REGD(0x0800B49C) = 0x00000080;
	REGD(0x0800B4A0) = 0x000001FF;
	REGD(0x0800B4A4) = 0x0000006F;
	REGD(0x0800B4A8) = 0x00000FFF;
	REGD(0x0800B4AC) = 0x00000FFF;
	REGD(0x0800B500) = 0x44440002;
	REGD(0x0800B504) = 0x00003201;
	REGD(0x0800B510) = 0x00000100;
	REGD(0x0800B514) = 0x00000001;
	REGD(0x0800B518) = 0x00000100;
	REGD(0x0800B51C) = 0x100;
	REGD(0x0800B520) = 0x00000FFF;
	REGD(0x0800B524) = 0x00000000;
	REGD(0x0800B528) = 0x00000FFF;
	REGD(0x0800B52C) = 0xFFF;
	REGD(0x0800B580) = 0x44440002;
	REGD(0x0800B584) = 0x00003210;
	REGD(0x0800B590) = 0x00000400;
	REGD(0x0800B594) = 0x00000100;
	REGD(0x0800B598) = 0x0;
	REGD(0x0800B59C) = 0x0;
	REGD(0x0800B5A0) = 0x00000FFF;
	REGD(0x0800B5A4) = 0x00000FFF;
	REGD(0x0800B5A8) = 0x0;
	REGD(0x0800B5AC) = 0x0;
	REGD(0x0800B800) = 0x0;
	REGD(0x0800B880) = 0x0;
	REGD(0x0800B900) = 0x0;
	REGD(0x0800B980) = 0x0;
	REGD(0x0800BA00) = 0x0;
	REGD(0x0800BA80) = 0x0;
	REGD(0x0800BB00) = 0x0;
	REGD(0x0800BB80) = 0x0;
	REGD(0x0800BD00) = 0x0;
	REGD(0x0800BD04) = 0x00213045;
	REGD(0x0800B00C) = 0x00000000;
}
